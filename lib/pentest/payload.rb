module Pentest
  class Payload
    attr_accessor :params, :values, :penetration_confidence, :injection, :penetration_message, :penetration_type

    def initialize(data = {})
      @route = data.fetch(:route)
      @params = data.fetch(:params, [])
      @values = data.fetch(:values, [])
      @injection = data.fetch(:injection, '')
      @injection_point = data.fetch(:injection_point, nil)

      @penetration_confidence = nil
      @penetration_message = nil
      @penetration_type = nil
    end

    def params_hash
      @params.zip(@values).to_h
    end

    def to_s
      params_hash.each_with_index do |(param, value), index|
        if @route.required_parts.include? param
          options[param] = value
        else
          if @injection_point == index
            if @penetration_confidence == :attack
              query_parameters << [param, URI.encode(@injection).red]
            else
              query_parameters << [param, '[malicious payload]'.red]
            end
          else
            query_parameters << [param, URI.encode(value)]
          end
        end
      end

      puts "#{' ' * 6} #{@route.verb} #{@route.format(options)}"

      query_parameters.each_with_index do |(param, value), index|
        key = if param.size == 1
          param[0]
        else
          "#{param[0]}[#{param[1]}]"
        end

        puts "#{' ' * (7 + @route.verb.size)} #{index == 0 ? '?' : '&'}#{key}=#{value}"
      end
    end
  end
end