require 'arproxy'

module Pentest
  class SqlProxy < Arproxy::Base
    @handlers = nil
    @parser = nil

    def self.enable!(handler)
      Arproxy.configure do |config|
        config.use self
      end
      Arproxy.enable!
      Arproxy.proxy_chain.head.register_handler(handler)
    end

    def self.disable!(handler)
      Arproxy.proxy_chain.head.unregister_handler(handler)
      Arproxy.disable!
    end

    def initialize
      @handler = nil
    end

    def register_handler(handler)
      @handler = handler
    end

    def unregister_handler(handler)
      @handler = nil
    end

    def exec_query(*args)
      sql, = args
      unless @handler.nil?
        @handler.call(sql)
      end
      super(*args)
    end
  end
end