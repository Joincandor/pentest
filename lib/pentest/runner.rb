require 'pentest/endpoint'

module Pentest
  class Runner
    def initialize(app_path)
      @app_path = app_path
      @routes = ::Rails.application.routes.routes
    end

    def run
      @endpoints = @routes.map do |route|
        endpoint = Endpoint.new(route, app_path)
      end.select(&:valid?)

      Logger.debug "Fetched #{@endpoints.size} endpoints"
      Logger.print_seperator

      user = User.first
      user.admin = true
      user.save!

      payloads = []
      @endpoints.each do |endpoint|
        payloads += endpoint.scan!
        Logger.print_seperator
      end

      if payloads.empty?
        Logger.info 'No vulnerabilities found'
      else
        Logger.error "#{payloads.size} vulnerabilities found"

        payloads.each_with_index do |payload, index|
          puts ''
          puts payload.to_s(index)
        end
      end
    end
  end
end